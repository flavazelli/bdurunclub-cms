jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Google Cloud credentials
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      - name: Fetch the secret from Google Secret Manager
        run: |
          # Fetch the secret as a file and save it
          gcloud secrets versions access latest --secret="app_env" --format="json" > app_env.json

      - name: Convert JSON to .env format
        run: |
          # Convert the fetched secret JSON to environment variable format
          cat app_env.json | jq -r 'to_entries[] | "\(.key)=\(.value)"' > /opt/infra/docker-compose/.env

      - name: Pull and restart backend containers
        run: |
          cd /opt/infra/docker-compose
          docker-compose pull backend
          docker-compose up -d backend
